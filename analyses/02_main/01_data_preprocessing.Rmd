---
title: "Conformity of Norms Replication Preprocessing"
author: "Group 5"
date: "July 28,2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error = F, message = F, warning = F)
```

```{r libraries, include=FALSE, message=FALSE, warning=FALSE}

library(tidyverse)
library(readr)
library(dplyr)

```


### Importing the data

```{r, results='hide'}

df <- read_csv("01_raw_data.csv")

df %>% 
  head()
```



### Glimps of the data

```{r}

df %>% 
  glimpse()

```


### Unique submission IDs with their counts

```{r}

df %>%
  group_by(submission_id) %>% 
  count() %>% 
  unique()

```


### Unique trials according to `trial_name`

```{r}

df %>% 
  group_by(trial_name) %>% 
  tally()

```


### Omitting the unnecessary columns and trials for the analysis

```{r}

df_cleaned <- df %>% 
  select(
    -c(
      QUD,
      RT,
      optionLeft,
      optionRight,
      startDate,
      startTime,
      trial_number
    )
  ) %>% 
  filter(
    trial_name != "choice_of_political_topic" &
      trial_name != "fit_backstory_fake_rating" &
      trial_name != "understanding_check2"
  )

```


```{r}

df_cleaned %>% 
  group_by(trial_name) %>% 
  tally()

```

### Glimps after columns are removed

```{r}

df_cleaned %>% 
  glimpse()

```


### Removing participants who failed the understanding check

```{r}

df_cleaned <- df_cleaned %>% 
  mutate(
    invalid = case_when(
      trial_name == "understanding_check" &
        response == "incorrect" ~ TRUE,
      TRUE ~ FALSE
      ),
    )

invalid_ids <- df_cleaned$submission_id[which(df_cleaned$invalid == TRUE)]

removed_invalid <- sum(df_cleaned$invalid)

for (id in invalid_ids) {
  df_cleaned <- df_cleaned %>% 
    filter(
      submission_id != id
    )
  }


print(
  paste0(
    "We excluded ", removed_invalid, " participant(s) for failing the understanding check."
    )
  )

```



```{r}

df_cleaned %>% 
  group_by(submission_id) %>% 
  count() %>% 
  unique()

```


### excluding neutral participants to their chosen social issue 

```{r}

df_cleaned <- df_cleaned %>% 
  mutate(
    neutral = case_when(
      trial_name == "rate_statement" &
        response == 0 ~ TRUE,
      TRUE ~ FALSE
      )
    )

neutral_ids <- df_cleaned$submission_id[which(df_cleaned$neutral == TRUE)]

removed_neutral <- sum(df_cleaned$neutral)

for (id in neutral_ids) {
  df_cleaned <- df_cleaned %>% 
    filter(
      submission_id != id
    )
  }


print(
  paste0(
    "We excluded ", removed_neutral, " participant(s) for being neutral about their chosen social activity."
    )
  )

```


### Dropping invalid and neutral columns

```{r}

df_cleaned <- df_cleaned %>% 
  select(
    -c(
      invalid,
      neutral
    )
  )

```

```{r}

df_cleaned %>% 
  glimpse()

```

```{r}

df_cleaned <- 
  df_cleaned %>% 
  pivot_wider(
    id_cols = c(
      submission_id, 
      age,
      condition,
      gender
      ),
    names_from = trial_name,
    values_from = response
  ) %>% 
  select(
    -c(
      understanding_check
    )
  )

```

# Demographics

```{r}

# this chunk is taken from the original study and is modified for the replication study
df_cleaned_no_na <-
  df_cleaned %>%
  drop_na()
  # select(age, gender) %>%
  
demographics_summary <- 
  tibble(mean_age = signif(mean(df_cleaned_no_na$age), 1),
            min_age = min(df_cleaned_no_na$age),
            max_age = max(df_cleaned_no_na$age),
            sd_age = signif(sd(df_cleaned_no_na$age), 1),
            median_ag = median(df_cleaned_no_na$age),
            N = length(df_cleaned_no_na$age),
            prop_males = signif(sum(df_cleaned_no_na$gender=="male")/N, 1),
            prop_females = signif(sum(df_cleaned_no_na$gender=="female")/N, 1),
            prop_rest = signif(1-(prop_males+prop_females), 1),
  )

demographics_summary

```

```{r}

df_cleaned %>% 
  ggplot(aes(age)) +
  geom_bar()

```
```{r}
df_cleaned %>% 
  group_by(gender) %>%
  tally()
```

```{r}

df_cleaned$gender <-
  ifelse(is.na(df_cleaned$gender), "prefer_not_to_say", df_cleaned$gender)

```

```{r}
df_cleaned %>% 
  group_by(gender) %>%
  tally()
```

```{r}
df_cleaned %>% 
  group_by(age) %>%
  tally()
```

```{r}

mean_age <- 
  df_cleaned %>% 
  filter(
    age < 100, 
    !is.na(age)
    ) %>% 
  summarise(
    value = round(mean(age))
  )


df_cleaned$age <-
  if_else(df_cleaned$age > 100 , mean_age$value, df_cleaned$age, missing = mean_age$value)

```

```{r}
df_cleaned %>% 
  group_by(age) %>%
  tally()
```

```{r}

df_cleaned %>% 
  ggplot(aes(age)) +
  geom_bar()

```
```{r}
demographics_summary <- 
  tibble(mean_age = signif(mean(df_cleaned$age), 1),
            min_age = min(df_cleaned$age),
            max_age = max(df_cleaned$age),
            sd_age = signif(sd(df_cleaned$age), 1),
            median_ag = median(df_cleaned$age),
            N = length(df_cleaned$age),
            prop_males = signif(sum(df_cleaned$gender=="male")/N, 1),
            prop_females = signif(sum(df_cleaned$gender=="female")/N, 1),
            prop_rest = signif(1-(prop_males+prop_females), 1),
  )

demographics_summary
```

### Encoding variables for analysis

```{r}
df_cleaned <- 
  df_cleaned %>%
  mutate(
    ingroupNorm = case_when(
      condition == 1 |
        condition == 3 
      ~ -1,   # reporting robber
      condition == 2 |
        condition == 4 
      ~ 1    # leave him alone
    ),
    bothShown = case_when(
      condition == 1 |
        condition == 2 
      ~ 0,   # only ingroup
      condition == 3 |
        condition == 4 
      ~ 1    # both in and outgroup
      )
    )
```


```{r}

df_cleaned <- 
  df_cleaned %>% 
  mutate(
    ingroupAgree = ifelse(
      identity_check_Pro >= 5, 1, 0
      ),
    outgroupDisagree = ifelse(
      identity_check_Anti <= 3, 1, 0
      )
    ) %>% 
  rename(response = experimental_trial)

```


```{r}

df_cleaned %>%
  glimpse()

```


### Storing the cleaned dataset

```{r}

write.csv(df_cleaned,"02_clean_data.csv", row.names = FALSE)

```


