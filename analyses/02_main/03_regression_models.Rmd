---
title: "Conformity of Norms Replication Analysis"
author: "Group 5"
date: "July 28,2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error = F, message = F, warning = F)
```

# analysis based on the original analysis scripts of 

Pryor C, Perfors A, Howe PDL (2019)
Conformity to the descriptive norms of people with
opposing political or social beliefs. PLoS ONE 14
(7): e0219464. https://doi.org/10.1371/journal.
pone.0219464

# to be found [here](https://osf.io/tgf96/?view_only=7dc67fcc0c1f4fdea8fe1dfe5d492480)

```{r libraries, include=FALSE, message=FALSE, warning=FALSE}

library(ordinal)
library(tidyverse)
library(rstan)
library(bridgesampling)
library(shinystan)
library(dplyr)
library(brms)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
set.seed(123)

```


### Importing the data

```{r, results='hide'}

df_cleaned <- read_csv("02_clean_data.csv")

```


```{r}

df_cleaned %>% 
  head()

```

#Demographics---------------

```{r}

demographics_summary <- 
  df_cleaned %>% 
  drop_na() %>% 
  group_by(condition) %>% 
  summarize(mean_age = signif(mean(age), 1),
            min_age = min(age),
            max_age = max(age),
            sd_age = signif(sd(age), 1),
            median_ag = median(age),
            N = length(age),
            prop_males = signif(sum(gender=="male")/N, 1),
            prop_females = signif(sum(gender=="female")/N, 1),
            prop_nonBinary = signif(sum(gender == "non-binary")/N, 1),
            prop_notSaid = signif(sum(gender == "prefer_not_to_say")/N, 1)
  )

demographics_summary

```

#Frequentist Analysis----------------

```{r}

(ordinal <- clm(as.factor(response)~ingroupNorm*bothShown, data=df_cleaned))

```


# Bayesian analysis------------
#--Set up data for stan.

```{r}

useable_data <- 
  df_cleaned %>%
  select(
    response, 
    ingroupNorm, 
    bothShown, 
    ingroupAgree, 
    outgroupDisagree
    ) %>% #select relevant columns
  mutate(
    ingroupAgree = 
      ifelse(is.na(ingroupAgree), 1, ingroupAgree), 
    outgroupDisagree = 
      ifelse(is.na(outgroupDisagree), 1, outgroupDisagree)
    ) # We assumed that participants identified with the ingroup and not with the outgroup.

stan_data <- as.list(
  c(
    useable_data, 
    N = dim(useable_data)[1]
    )
  )

```


#--Fit models

```{r}

fit_SCT <- 
  stan(
    file = "stan_models/SCT.stan", 
    data=stan_data, 
    iter=10000, 
    chains=4, 
    seed=123, 
    control=
      list(
        adapt_delta = 0.99
        )
    )

fit_SCT

```


```{r}

fit_herding <- 
  stan(
    file = "stan_models/herding.stan", 
    data=stan_data, 
    iter=10000, 
    chains=4, 
    control=
      list(
        adapt_delta = 0.99
        )
    )

fit_herding

```

#----Check diagnostics
#launch_shinystan(fit_SCT)

#--Compare models using Bayes Factors

```{r}

marg_lik_SCT <- 
  bridge_sampler(
    samples = fit_SCT
    )

```


```{r}

marg_lik_herding <- 
  bridge_sampler(
    samples = fit_herding
    )

```


```{r}

bf(
  marg_lik_herding, 
  marg_lik_SCT
  )

```


# Bayesian analysis with brms

```{r}
get_prior(response ~ ingroupNorm + bothShown + ingroupNorm*bothShown,
          data = df_cleaned)
```
```{r}
priors <- c(
  prior(normal(0.6/0.75 * 1.27 , 0.5), class = b, coef = ingroupNorm),
  prior(normal(0, 0.5), class = b, coef = bothShown),
  prior(normal(0, 0.5), class = b, coef = ingroupNorm:bothShown)
  )
```

```{r}
fit_df_cleaned_SCT <- brm(
  response ~ ingroupNorm + bothShown + ingroupNorm*bothShown,
  data = df_cleaned,
  iter = 20000,
  prior = priors,
  sample_prior = 'yes'
)
```

```{r}
fit_df_cleaned_SCT
```

# Hypothesis testing
```{r}
hypothesis(fit_df_cleaned_SCT, "bothShown < 0")
```
```{r}
hypothesis(fit_df_cleaned_SCT, "ingroupNorm:bothShown > ingroupNorm")
```

# ```{r}
# get_prior(response ~ ingroupNorm*ingroupAgree + bothShown + ingroupNorm*bothShown*outgroupDisagree,
#           data = df_cleaned)
# ```
# 
# ```{r}
# 
# priors_herding <- c(
#   prior(normal(0,10), class = b, coef = bothShown:outgroupDisagree),
#   prior(normal(0,10), class = b, coef = ingroupAgree),
#   prior(normal(0,10), class = b, coef = ingroupNorm:bothShown:outgroupDisagree),
#   prior(normal(0,10), class = b, coef = ingroupNorm:ingroupAgree),
#   prior(normal(0,10), class = b, coef = ingroupNorm:outgroupDisagree),
#   prior(normal(0,10), class = b, coef = outgroupDisagree),
#   prior(normal(0.6/0.75 * 1.27 , 0.5), class = b, coef = ingroupNorm),
#   prior(normal(0, 0.5), class = b, coef = bothShown),
#   prior(normal((0.6/0.75 * 1.27)*(-0.85 / 0.6), 0.5*(-0.85 / 0.6)), class = b, coef = ingroupNorm:bothShown)
#   )
# 
# ```


# ```{r}
# 
# fit_df_cleaned_herding <- brm(
#   response ~ ingroupNorm*ingroupAgree + bothShown + ingroupNorm*bothShown*outgroupDisagree,
#   data = df_cleaned,
#   # iter = 20000,
#   iter = 10,
#   prior = priors_herding
# )
# 
# ```
# 
# ```{r}
# fit_df_cleaned_herding
# ```
